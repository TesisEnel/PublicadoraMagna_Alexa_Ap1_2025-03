@page "/admin/periodistas"
@layout AdminLayout
@attribute [Authorize(Roles = "Admin")]
@inject PeriodistaService PeriodistaService
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager Navigation
@rendermode InteractiveServer

@using Microsoft.EntityFrameworkCore

<PageTitle>Gestión de Periodistas</PageTitle>

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-magna-dark"><i class="bi bi-people-fill me-2"></i>Gestión de Periodistas</h2>
        <button class="btn btn-magna-orange shadow-sm" @onclick="IrACrear">
            <i class="bi bi-plus-circle"></i> Nuevo Periodista
        </button>
    </div>

    @if (cargando)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-magna-dark" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
        </div>
    }
    else
    {
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card card-stat bg-magna-dark text-white shadow">
                    <div class="card-body">
                        <h5 class="card-title"><i class="bi bi-people me-1"></i> Total Periodistas</h5>
                        <h2>@PeriodistasFiltrados.Count</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card card-stat bg-magna-green text-white shadow">
                    <div class="card-body">
                        <h5 class="card-title"><i class="bi bi-person-check me-1"></i> Activos</h5>
                        <h2>@periodistas.Count(p => p.EsActivo)</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card card-stat bg-magna-orange text-white shadow">
                    <div class="card-body">
                        <h5 class="card-title"><i class="bi bi-person-x me-1"></i> Inactivos</h5>
                        <h2>@periodistas.Count(p => !p.EsActivo)</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card card-stat bg-magna-light-green shadow">
                    <div class="card-body">
                        <h5 class="card-title"><i class="bi bi-journal-text me-1"></i> Artículos Totales</h5>
                        <h2 class="text-magna-dark">@periodistas.Sum(p => p.Articulos?.Count ?? 0)</h2>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4 shadow-sm p-3">
            <div class="row g-2 align-items-end">
                <!-- Desde -->
                <div class="col-md-3">
                    <label class="form-label fw-semibold small"><i class="bi bi-calendar me-1"></i>Desde</label>
                    <InputDate class="form-control" @bind-Value="fechaDesde" />
                </div>

                <!-- Hasta -->
                <div class="col-md-3">
                    <label class="form-label fw-semibold small"><i class="bi bi-calendar me-1"></i>Hasta</label>
                    <InputDate class="form-control" @bind-Value="fechaHasta" />
                </div>

                <!-- Filtrar por -->
                <div class="col-md-3">
                    <label class="form-label fw-semibold small"><i class="bi bi-funnel me-1"></i>Filtrar por</label>
                    <InputSelect class="form-select" @bind-Value="filtroEstado">
                        <option value="">Todos los Estados</option>
                        <option value="activo">Activos</option>
                        <option value="inactivo">Inactivos</option>
                    </InputSelect>
                </div>

                <!-- Búsqueda -->
                <div class="col-md-3">
                    <label class="form-label fw-semibold small"><i class="bi bi-search me-1"></i>Búsqueda</label>
                    <div class="input-group">
                        <input class="form-control" placeholder="Buscar por nombre, apellido o email..." @bind="terminoBusqueda" />
                        <button class="btn btn-magna-orange" @onclick="Buscar">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        @if (!PeriodistasFiltrados.Any())
        {
            <div class="alert alert-info shadow-sm">
                <i class="bi bi-info-circle"></i> No hay periodistas que coincidan con los filtros aplicados.
            </div>
        }
        else
        {
            <div class="card shadow-sm border-0">
                <div class="card-header bg-magna-dark text-white">
                    <i class="bi bi-list-ul me-2"></i> Listado (Mostrando @PeriodistasFiltrados.Count)
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead>
                                <tr class="bg-light">
                                    <th>Nombre</th>
                                    <th>Email</th>
                                    <th>Tarifa Base</th>
                                    <th>Estado</th>
                                    <th>Artículos</th>
                                    <th>Fecha Registro</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var periodista in PeriodistasFiltrados)
                                {
                                    <tr>
                                        <td class="fw-bold">@periodista.Nombres</td>
                                        <td>
                                            @if (emailsPeriodistas.ContainsKey(periodista.PeriodistaId))
                                            {
                                                <span class="text-muted">@emailsPeriodistas[periodista.PeriodistaId]</span>
                                            }
                                            else
                                            {
                                                <span class="text-danger small">Sin usuario asociado</span>
                                            }
                                        </td>
                                        <td>RD$ @periodista.TarifaBase.ToString("N0")</td>
                                        <td>
                                            @if (periodista.EsActivo)
                                            {
                                                <span class="badge bg-success">Activo</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-danger">Inactivo</span>
                                            }
                                        </td>
                                        <td>@(periodista.Articulos?.Count ?? 0)</td>
                                        <td>@periodista.FechaRegistro.ToString("dd/MM/yyyy")</td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-success me-1" @onclick="() => Editar(periodista.PeriodistaId)" title="Editar">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button class="btn btn-sm btn-warning" @onclick="() => CambiarEstado(periodista.PeriodistaId, !periodista.EsActivo)" title="Cambiar Estado">
                                                <i class="bi bi-toggle-on"></i>
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        }
    }
</div>

@code {
    private List<Periodista> periodistas { get; set; } = new();
    private Dictionary<int, string> emailsPeriodistas { get; set; } = new();
    private string terminoBusqueda { get; set; } = string.Empty;
    private string filtroEstado { get; set; } = string.Empty;
    private bool cargando { get; set; } = true;
    private DateTime? fechaDesde { get; set; }
    private DateTime? fechaHasta { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await CargarPeriodistas();
    }

    private async Task CargarPeriodistas()
    {
        try
        {
            cargando = true;
            periodistas = await PeriodistaService.Listar();

            var users = await UserManager.Users
                .Where(u => u.PeriodistaId != null)
                .Select(u => new { u.PeriodistaId, u.Email })
                .ToListAsync();

            emailsPeriodistas = users.ToDictionary(u => u.PeriodistaId!.Value, u => u.Email ?? "Email no disponible");
        }
        finally
        {
            cargando = false;
        }
    }

    private List<Periodista> PeriodistasFiltrados => periodistas
        .Where(p => string.IsNullOrWhiteSpace(terminoBusqueda)
                    || p.Nombres.Contains(terminoBusqueda, StringComparison.OrdinalIgnoreCase)
                    || (emailsPeriodistas.ContainsKey(p.PeriodistaId)
                        && emailsPeriodistas[p.PeriodistaId].Contains(terminoBusqueda, StringComparison.OrdinalIgnoreCase)))
        .Where(p => filtroEstado == "activo" ? p.EsActivo
                    : filtroEstado == "inactivo" ? !p.EsActivo
                    : true)
        .Where(p => !fechaDesde.HasValue || p.FechaRegistro >= fechaDesde.Value)
        .Where(p => !fechaHasta.HasValue || p.FechaRegistro <= fechaHasta.Value)
        .ToList();

    private void Buscar()
    {
        // Solo forzar reevaluación
        _ = PeriodistasFiltrados;
    }

    private void IrACrear() => Navigation.NavigateTo("/admin/periodistas/crear");
    private void Editar(int id) => Navigation.NavigateTo($"/admin/periodistas/editar/{id}");
    private async Task CambiarEstado(int id, bool nuevoEstado)
    {
        await PeriodistaService.CambiarEstado(id, nuevoEstado);
        await CargarPeriodistas();
    }
}

<style>
    .bg-magna-dark {
        background-color: #103713 !important;
        color: white;
    }

    .bg-magna-green {
        background-color: #2d5f4d !important;
        color: white;
    }

    .bg-magna-orange {
        background-color: #e65100 !important;
        color: white;
    }

    .bg-magna-light-green {
        background-color: #e8f5e9 !important;
        color: #103713;
    }

    .btn-magna-orange {
        background-color: #e65100;
        color: white;
        border-color: #e65100;
    }

        .btn-magna-orange:hover {
            background-color: #bf360c;
            border-color: #bf360c;
            color: white;
        }

    .btn-magna-green {
        background-color: #2d5f4d;
        color: white;
        border-color: #2d5f4d;
    }

        .btn-magna-green:hover {
            background-color: #1a4231;
            border-color: #1a4231;
            color: white;
        }

    .card-stat {
        border-radius: 12px;
        transition: transform 0.2s;
    }

        .card-stat:hover {
            transform: translateY(-3px);
        }
</style>
