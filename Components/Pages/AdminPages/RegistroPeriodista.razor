@page "/registro/periodista"
@using PublicadoraMagna.Data
@using PublicadoraMagna.Model
@using PublicadoraMagna.Services
@using Microsoft.AspNetCore.Identity
@inject PeriodistaService PeriodistaService
@inject SignInManager<ApplicationUser> SignInManager
@inject NavigationManager navigationManager
@rendermode InteractiveServer

<PageTitle>Registrar Periodista</PageTitle>

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-lg">
                <div class="card-header bg-success text-white text-center">
                    <h3>Únete como Periodista</h3>
                    <p class="mb-0">Publica tus artículos y genera ingresos</p>
                </div>

                <div class="card-body p-4">
                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="bi bi-exclamation-triangle"></i> @errorMessage
                            <button type="button" class="btn-close" @onclick="@(() => errorMessage = string.Empty)"></button>
                        </div>
                    }

                    @if (registroExitoso)
                    {
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle"></i> ¡Registro exitoso! Redirigiendo a tu panel...
                        </div>
                    }
                    else
                    {
                      
                        <div class="mb-4">
                            <h5 class="border-bottom pb-2">
                                <i class="bi bi-person"></i> Tus Datos
                            </h5>
                            
                            <div class="mb-3">
                                <label class="form-label">Nombre Completo <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" @bind="periodista.Nombres" 
                                       placeholder="Ej: María García López" />
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Tarifa Base (RD$) <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" @bind="periodista.TarifaBase" 
                                       placeholder="Ej: 7000" />
                                <small class="text-muted">
                                    <i class="bi bi-info-circle"></i> Esta es la tarifa que cobrarás por cada artículo publicado
                                </small>
                            </div>
                        </div>

                     
                        <div class="mb-4">
                            <h5 class="border-bottom pb-2">
                                <i class="bi bi-key"></i> Datos de Acceso
                            </h5>
                            
                            <div class="mb-3">
                                <label class="form-label">Email <span class="text-danger">*</span></label>
                                <input type="email" class="form-control" @bind="email" 
                                       placeholder="Ej: maria.garcia@ejemplo.com" />
                                <small class="text-muted">
                                    <i class="bi bi-info-circle"></i> Usarás este email para iniciar sesión
                                </small>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Contraseña <span class="text-danger">*</span></label>
                                    <input type="password" class="form-control" @bind="password" />
                                    <small class="text-muted">Mínimo 6 caracteres</small>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Confirmar Contraseña <span class="text-danger">*</span></label>
                                    <input type="password" class="form-control" @bind="confirmarPassword" />
                                </div>
                            </div>
                        </div>

                    
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="aceptaTerminos" @bind="aceptaTerminos">
                                <label class="form-check-label" for="aceptaTerminos">
                                    Acepto los <a href="/terminos" target="_blank">términos y condiciones</a> 
                                    y la <a href="/privacidad" target="_blank">política de privacidad</a>
                                </label>
                            </div>
                        </div>

                        <small class="text-muted d-block mb-3">
                            <span class="text-danger">*</span> Campos obligatorios
                        </small>
                    }
                </div>

                <div class="card-footer bg-light">
                    @if (!registroExitoso)
                    {
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-success btn-lg" @onclick="Registrarse" disabled="@registrando">
                                @if (registrando)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                    <span>Registrando...</span>
                                }
                                else
                                {
                                    <i class="bi bi-check-circle"></i>
                                    <span>Registrarme como Periodista</span>
                                }
                            </button>
                        </div>
                        <div class="text-center mt-3">
                            <small>
                                ¿Ya tienes cuenta? <a href="/Account/Login">Inicia sesión aquí</a>
                            </small>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    public Periodista periodista { get; set; } = new Periodista();
    public string email { get; set; } = string.Empty;
    public string password { get; set; } = string.Empty;
    public string confirmarPassword { get; set; } = string.Empty;
    public bool aceptaTerminos { get; set; } = false;
    public string errorMessage { get; set; } = string.Empty;
    public bool registrando { get; set; } = false;
    public bool registroExitoso { get; set; } = false;

    private async Task Registrarse()
    {
        errorMessage = string.Empty;
        registrando = true;

        try
        {
       
            if (string.IsNullOrWhiteSpace(periodista.Nombres))
            {
                errorMessage = "Tu nombre completo es requerido";
                registrando = false;
                return;
            }

            if (periodista.TarifaBase <= 0)
            {
                errorMessage = "Debes establecer una tarifa base mayor a 0";
                registrando = false;
                return;
            }

            if (string.IsNullOrWhiteSpace(email))
            {
                errorMessage = "El email es requerido";
                registrando = false;
                return;
            }

            if (string.IsNullOrWhiteSpace(password))
            {
                errorMessage = "La contraseña es requerida";
                registrando = false;
                return;
            }

            if (password.Length < 6)
            {
                errorMessage = "La contraseña debe tener al menos 6 caracteres";
                registrando = false;
                return;
            }

            if (password != confirmarPassword)
            {
                errorMessage = "Las contraseñas no coinciden";
                registrando = false;
                return;
            }

            if (!aceptaTerminos)
            {
                errorMessage = "Debes aceptar los términos y condiciones";
                registrando = false;
                return;
            }
            var creado = await PeriodistaService.CrearConUsuario(
                periodista,
                email,
                password
            );

            if (!creado)
            {
                errorMessage = "No se pudo completar el registro. El email podría estar ya registrado.";
                registrando = false;
                return;
            }

            var user = await SignInManager.UserManager.FindByEmailAsync(email);
            if (user != null)
            {
                await SignInManager.SignInAsync(user, isPersistent: false);
                registroExitoso = true;
              
                navigationManager.NavigateTo("/periodista/dashboard", forceLoad: true);
            }
            else
            {
               
                navigationManager.NavigateTo("/Account/Login");
            }
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
            registrando = false;
        }
    }
}
